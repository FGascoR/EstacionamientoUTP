<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTP Estacionamiento</title>
    <link rel="icon" type="image/png" th:href="@{/img/img.png}">
    <link rel="stylesheet" th:href="@{/css/stylesprincipal.css}">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

<div id="loader-container">
    <div class="loader-text">Cargando...</div>
    <svg class="spinner" viewBox="0 0 50 50">
        <circle class="path" cx="25" cy="25" r="20"></circle>
    </svg>
</div>

<header class="header">
    <div class="header-left">
        <img th:src="@{/img/utp.png}" alt="Logo UTP" class="logo-utp">
    </div>
    <div class="header-right">
        <span class="material-symbols-outlined help-icon">help</span>
        <div class="user-info">
            <span class="user-name">Hola, <span th:text="${usuario.nombre}"></span></span>
            <span class="user-code" th:text="${usuario.usuario}"></span>
        </div>
        <div class="user-avatar"></div>
        <div class="user-menu-container">
            <div class="user-toggle">
                <span id="arrowIcon" class="material-symbols-outlined" style="color:#555; cursor:pointer;">expand_more</span>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <a href="#"><span class="material-symbols-outlined">account_circle</span> Ver perfil</a>
                <a href="#" id="btnVehiculos"><span class="material-symbols-outlined">directions_car</span> Vehículos</a>
                <a href="#"><span class="material-symbols-outlined">lock</span> Cambiar contraseña</a>
                <form id="logoutForm" action="/logout" method="post" style="display:none;">
                    <input type="hidden" name="_csrf" th:value="${_csrf.token}">
                </form>
                <a href="#" onclick="document.getElementById('logoutForm').submit();">
                    <span class="material-symbols-outlined">logout</span> Cerrar sesión
                </a>
            </div>
        </div>
    </div>
</header>

<div id="modalVehiculos" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <span id="cerrarModalVehiculos" class="material-symbols-outlined close-btn">close</span>
        <h2 class="titulo-modal">Mis Vehículos</h2>
        <table class="vehiculos-table">
            <thead><tr><th>Tipo</th><th>Placa</th><th>Acciones</th></tr></thead>
            <tbody id="vehiculosTableBody"></tbody>
        </table>
        <h3 class="titulo-modal">Agregar Vehículo</h3>
        <div class="form-grid" style="margin-top:10px;">
            <select id="nuevoTipoVehiculo">
                <option value="">Seleccione tipo</option>
                <option th:each="tipo : ${tiposVehiculo}" th:value="${tipo.id}" th:text="${tipo.nombre}"></option>
            </select>
            <input type="text" id="nuevaPlaca" placeholder="Placa" />
            <button id="btnAgregarVehiculo" class="btn-reservar">Agregar</button>
        </div>
    </div>
</div>

<div id="menuOverlay" class="menu-overlay"></div>

<nav class="sidebar">
    <div class="menu-top-button">
        <span class="material-symbols-outlined">menu</span>
    </div>
    <ul class="nav-menu">
        <li class="nav-item" id="btnEstacionamiento">
            <a href="#"><span class="material-symbols-outlined">home</span> Estacionamiento</a>
        </li>
        <li class="nav-item" id="btnReservaciones">
            <a href="#"><span class="material-symbols-outlined">directions_car</span> Reservaciones</a>
        </li>
    </ul>
</nav>

<main class="main-content" id="main-content">
    <section id="vistaEstacionamiento">
        <h1>Estacionamiento</h1>
        <hr>
        <div class="dashboard-container">
            <div class="map-card">
                <h3>Mapa Completo:</h3>
                <img th:src="@{/img/MapaCompleto.png}" alt="MapaCompleto">
            </div>
            <div class="sector-maps-column">
                <div class="map-card"><h3>Sector: A</h3><img th:src="@{/img/SectorA.png}" alt="Sector A"></div>
                <div class="map-card"><h3>Sector: B</h3><img th:src="@{/img/SectorB.png}" alt="Sector B"></div>
                <div class="map-card"><h3>Sector: C</h3><img th:src="@{/img/SectorC.png}" alt="Sector C"></div>
            </div>
            <div class="status-area">
                <h4>Espacios Generales</h4>
                <div class="status-box disponible">
                    <div class="icon-box"><span class="material-symbols-outlined">event_available</span></div>
                    <span class="text">Espacios disponibles:</span><span class="count" th:text="${disponibles}">0</span>
                </div>
                <div class="status-box ocupado">
                    <div class="icon-box"><span class="material-symbols-outlined">event_busy</span></div>
                    <span class="text">Espacios ocupados:</span><span class="count" th:text="${ocupados}"></span>
                </div>
                <div th:each="sector : ${sectores}" class="sector-box">
                    <h4 th:text="'Sector ' + ${sector.nombre}" th:attr="data-id=${sector.id}"></h4>
                    <div class="sector-status">
                        <div class="status-box">
                            <div class="icon-box"><span class="material-symbols-outlined">event_available</span></div>
                            <span class="text">Libres:</span><span class="count" th:text="${sector.espaciosDisponibles}">0</span>
                        </div>
                        <div class="status-box">
                            <div class="icon-box"><span class="material-symbols-outlined">event_busy</span></div>
                            <span class="text">Ocupados:</span><span class="count" th:text="${sector.espaciosOcupados}">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="vistaReservaciones" style="display:none;">
        <h1>Reservaciones</h1>
        <p style="margin-top:-2px; color:#555;">Gestiona fácilmente tu acceso al estacionamiento</p>

        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div class="status-box" style="flex:1;">
                <div class="icon-box"><span class="material-symbols-outlined">event_available</span></div>
                <span class="text">Espacios disponibles:</span><span class="count" th:text="${disponibles}"></span>
            </div>
            <div class="status-box" style="flex:1;">
                <div class="icon-box"><span class="material-symbols-outlined">event_busy</span></div>
                <span class="text">Espacios ocupados:</span><span class="count" th:text="${ocupados}"></span>
            </div>
        </div>
        <hr style="margin-bottom: 10px;">

        <div th:if="${reservaActiva == null}" id="empty-state-container" style="text-align:center; padding: 2rem 0;">
            <img th:src="@{/img/SinReserva.png}" alt="Auto" style="width:160px; opacity:0.85; margin-bottom: 1rem;">
            <p style="margin-top:20px; font-size:16px; color:#666;">Aún no tienes ninguna reserva</p>
        </div>

        <div th:if="${reservaActiva != null}" class="blue-section" id="blue-section-container">
            <div class="content-container">
                <div id="active-reservation-container">
                    <div class="reserva-activa-card">
                        <div class="reserva-info">
                            <div class="reserva-fechas">
                                <div class="info-item"><span class="material-symbols-outlined">calendar_today</span><span>Fecha: <strong th:text="${#temporals.format(reservaActiva.fechaReserva, 'dd/MM/yyyy')}"></strong></span></div>
                                <div class="info-item"><span class="material-symbols-outlined">schedule</span><span>Entrada: <strong th:text="${#temporals.format(reservaActiva.horaEntrada, 'HH:mm')}"></strong></span></div>
                                <div class="info-item"><span class="material-symbols-outlined">schedule</span><span>Salida: <strong th:text="${#temporals.format(reservaActiva.horaSalida, 'HH:mm')}"></strong></span></div>
                            </div>
                            <div class="reserva-lugar">
                                <h6>Datos de Lugar:</h6>
                                <p>Sector: <strong th:text="${reservaActiva.sector.nombre}"></strong></p>
                                <p>Lugar: <strong th:text="${reservaActiva.espacio.nombre}"></strong>
                                    <span th:if="${reservaActiva.subEspacio != null}" th:text="' - ' + ${reservaActiva.subEspacio.nombre}"></span>
                                </p>
                                <div class="btn-container">
                                    <button class="btn-detalles">Detalles</button>
                                    <button class="btn-cancelar" th:onclick="'solicitarCancelacion(' + ${reservaActiva.id} + ')'">Cancelar</button>
                                </div>
                            </div>
                            <div class="reserva-acciones">
                                <span class="status-chip">En Proceso</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="reservar-button-container" style="text-align:center; margin-top: 30px;">
            <button th:if="${reservaActiva == null}" id="btnAbrirReserva" class="btn-reservar-secondary">Reservar</button>
            <button th:if="${reservaActiva != null}" id="btnAbrirReservaNueva" class="btn-reservar-secondary">Reservar</button>
        </div>
    </section>
</main>

<div id="modalTipoVehiculo" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <span id="cerrarModal" class="material-symbols-outlined close-btn">close</span>
        <h2>Reservación:</h2>
        <p style="margin-top:-10px;">Seleccione el tipo de vehículo:</p>
        <div class="tipo-container">
            <div th:each="tipo : ${tiposVehiculo}" class="tipo-card" th:attr="data-id=${tipo.id}">
                <img th:src="@{'/img/iconos/' + ${tipo.nombre} + '.png'}">
                <span th:text="${tipo.nombre}"></span>
            </div>
        </div>
        <button class="btn-aceptar">Aceptar</button>
    </div>
</div>

<div id="modalFormularioReserva" class="modal-overlay" style="display:none;">
    <div class="modal-reserva">
        <span id="cerrarModalReserva" class="material-symbols-outlined close-btn">close</span>
        <h2 class="titulo-modal">Reservación: <img id="iconoVehiculo" src="" style="height:32px; vertical-align:middle;"></h2>
        <form id="formReserva" class="form-grid" th:action="@{/reservas/guardar}" method="post">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}">
            <div class="group"><label>Seleccione el día:</label><div class="input-icon"><input type="date" name="fecha" required></div></div>
            <div class="group"><label>Ingrese la hora de llegada:</label><div class="fila-hora"><input type="time" name="entrada" required></div></div>
            <div class="group"><label>Ingrese la hora de salida:</label><div class="fila-hora"><input type="time" name="salida" required></div></div>
            <div class="group"><label>Sector:</label><select id="sectorSelect" name="sectorId" required><option value="">Sector</option><option th:each="s : ${sectores}" th:text="${s.nombre}" th:value="${s.id}"></option></select></div>
            <div class="group"><label>Tipo de Vehículo:</label><input type="text" id="tipoVehiculoNombre" readonly></div>
            <div class="group" id="groupPlaca"><label for="placa">Placa del vehículo:</label><div class="input-icon"><input list="vehiculosUsuarioList" id="placa" name="placa" placeholder="Seleccione o ingrese una placa" required><datalist id="vehiculosUsuarioList"></datalist></div></div>
            <div class="group"><label style="opacity:0;">.</label><button type="button" id="btnVerSectores" class="btn-ver">Ver Sectores</button></div>
            <div class="group grupo-full"><img id="sectorImgPreview" src="" style="width:100%; display:none; border-radius:8px; margin-bottom:15px;"></div>
            <div class="leyenda"><span>Libre <div class="cuadro libre"></div></span><span>Ocupado <div class="cuadro ocupado"></div></span></div>
            <div class="grupo-full" id="espaciosContainer"></div>
            <div class="grupo-full" style="text-align:right; margin-top:20px;"><button id="btnGuardarReserva" type="submit" class="btn-reservar">Reservar</button></div>
        </form>
    </div>
</div>

<div id="modalSubEspacios" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="width: 500px; text-align: center;">
        <span id="cerrarModalSub" class="material-symbols-outlined close-btn">close</span>
        <h2 class="titulo-modal">Selecciona un sitio</h2>
        <p id="tituloSubEspacio" style="margin-bottom: 15px; font-weight: 600; color: #555;"></p>
        <div class="leyenda" style="justify-content:center; margin-bottom:20px;">
            <span>Libre <div class="cuadro libre"></div></span><span>Ocupado <div class="cuadro ocupado"></div></span>
        </div>
        <div id="containerSubEspacios" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom: 25px;"></div>
        <button id="btnAceptarSub" class="btn-aceptar" style="margin: 0 auto;">Aceptar</button>
    </div>
</div>

<div id="modalConfirmacion" class="modal-overlay" style="display:none;">
    <div class="modal-content-confirm">
        <span id="cerrarModalConfirmacion" class="material-symbols-outlined close-btn">close</span>
        <img th:src="@{/img/reserva-confirmada.png}" alt="Reserva Registrada" style="width: 120px;">
        <h2>Tu reserva de estacionamiento se ha registrado correctamente</h2>
        <p>Ten en cuenta tu hora de llegada y salida</p>
        <button id="btnAceptarConfirmacion" class="btn-aceptar-confirm">Aceptar</button>
    </div>
</div>

<div id="modalPreguntaCancelacion" class="modal-overlay" style="display:none;">
    <div class="modal-content-confirm">
        <span id="cerrarModalPregunta" class="material-symbols-outlined close-btn">close</span>
        <img th:src="@{/img/reserva-confirmada.png}" alt="Cancelar" style="width: 120px;">
        <h2>¿Estás seguro de cancelar la reserva?</h2>
        <p>Esta acción liberará tu espacio.</p>

        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btnVolverCancelacion" class="btn-aceptar-confirm" style="background-color: #f2eefd; color: #6a5af9;">Volver</button>
            <button id="btnConfirmarCancelacion" class="btn-aceptar-confirm">Sí, Cancelar</button>
        </div>
    </div>
</div>

<div id="modalErrorCancelacion" class="modal-overlay" style="display:none;">
    <div class="modal-content-confirm">
        <span id="cerrarModalError" class="material-symbols-outlined close-btn">close</span>
        <img th:src="@{/img/reserva-confirmada.png}" alt="Error" style="width: 120px;">
        <h2>No se puede cancelar</h2>
        <p>Faltan menos de 15 minutos para la entrada o el tiempo ya ha pasado.</p>
        <button id="btnAceptarError" class="btn-aceptar-confirm">Entendido</button>
    </div>
</div>

<div id="modalCancelacionExito" class="modal-overlay" style="display:none;">
    <div class="modal-content-confirm">
        <span id="cerrarModalCancelacion" class="material-symbols-outlined close-btn">close</span>
        <img th:src="@{/img/reserva-confirmada.png}" alt="Cancelada" style="width: 120px;">
        <h2>Reserva cancelada correctamente</h2>
        <p>El espacio ha sido liberado exitosamente.</p>
        <button id="btnAceptarCancelacion" class="btn-aceptar-confirm">Aceptar</button>
    </div>
</div>


<script>
    /* ===========================
       LOGICA GENERAL (MENÚ, VISTAS, TIPO) - SIN CAMBIOS IMPORTANTES
    =========================== */
    const toggle = document.querySelector('.user-toggle');
    const dropdown = document.getElementById('userDropdown');
    const overlay = document.getElementById('menuOverlay');
    const arrow = document.getElementById('arrowIcon');
    toggle.addEventListener('click', () => { const isOpen = dropdown.style.display === 'flex'; dropdown.style.display = isOpen ? 'none' : 'flex'; overlay.style.display = isOpen ? 'none' : 'block'; arrow.textContent = isOpen ? "expand_more" : "expand_less"; });
    overlay.addEventListener('click', () => { dropdown.style.display = 'none'; overlay.style.display = 'none'; arrow.textContent = "expand_more"; });

    const btnEst=document.getElementById("btnEstacionamiento"),btnRes=document.getElementById("btnReservaciones"),vistaEst=document.getElementById("vistaEstacionamiento"),vistaRes=document.getElementById("vistaReservaciones");
    btnEst.classList.add("active");
    btnEst.addEventListener("click",()=>{vistaEst.style.display="block";vistaRes.style.display="none";btnEst.classList.add("active");btnRes.classList.remove("active");});
    btnRes.addEventListener("click",()=>{vistaEst.style.display="none";vistaRes.style.display="block";btnRes.classList.add("active");btnEst.classList.remove("active");});

    const modalTipo=document.getElementById("modalTipoVehiculo"),btnAbrir=document.getElementById("btnAbrirReserva"),btnAbrirNueva=document.getElementById("btnAbrirReservaNueva"),btnCerrar=document.getElementById("cerrarModal");
    if(btnAbrir)btnAbrir.onclick=()=>modalTipo.style.display="flex";
    if(btnAbrirNueva)btnAbrirNueva.onclick=()=>modalTipo.style.display="flex";
    btnCerrar.onclick=()=>modalTipo.style.display="none";
    window.addEventListener("click",e=>{if(e.target===modalTipo)modalTipo.style.display="none"});

    document.querySelectorAll(".tipo-card").forEach(c=>{c.onclick=()=>{document.querySelectorAll(".tipo-card").forEach(cc=>cc.classList.remove("selected"));c.classList.add("selected");}});

    /* ===========================
       ACEPTAR TIPO
    =========================== */
    document.querySelector(".btn-aceptar").onclick=()=>{
        const sel=document.querySelector(".tipo-card.selected");
        if(!sel)return alert("Seleccione tipo");
        const idTipo=sel.getAttribute("data-id"), nombreTipo=sel.querySelector("span").innerText, iconoSrc=sel.querySelector("img").src;
        window.tipoSeleccionadoId=idTipo;

        const esBici=nombreTipo.toLowerCase().includes("bicicleta"), gp=document.getElementById("groupPlaca"), inp=document.getElementById("placa");
        if(gp){ if(esBici){ gp.style.display="none"; inp.removeAttribute("required"); inp.value=""; } else { gp.style.display="block"; inp.setAttribute("required","true"); } }

        document.getElementById("tipoVehiculoNombre").value=nombreTipo;
        document.getElementById("iconoVehiculo").src=iconoSrc;

        if(!esBici){ fetch(`/reservas/placas?tipoVehiculoId=${idTipo}`).then(r=>r.json()).then(d=>{ const l=document.getElementById("vehiculosUsuarioList"); l.innerHTML=""; d.forEach(v=>{const o=document.createElement("option");o.value=v.placa;l.appendChild(o)}) }) }

        modalTipo.style.display="none"; document.getElementById("modalFormularioReserva").style.display="flex";
        document.getElementById("formReserva").reset(); document.getElementById("espaciosContainer").innerHTML=""; document.getElementById("sectorImgPreview").style.display='none';
        document.getElementById("tipoVehiculoNombre").value=nombreTipo; document.getElementById("iconoVehiculo").src=iconoSrc;
        const hEsp = document.getElementById("espacioId"); if(hEsp) hEsp.value = "";
        const hSub = document.getElementById("subEspacioId"); if(hSub) hSub.value = "";
    };
    document.getElementById("cerrarModalReserva").onclick=()=>document.getElementById("modalFormularioReserva").style.display="none";

    /* ===========================
       CARGA DE ESPACIOS (AJAX)
    =========================== */
    const formRes=document.getElementById("formReserva");
    formRes.querySelector('input[name="fecha"]').onchange=fetchEspacios;
    formRes.querySelector('input[name="entrada"]').onchange=fetchEspacios;
    formRes.querySelector('input[name="salida"]').onchange=fetchEspacios;
    document.getElementById("sectorSelect").onchange=e=>{
        const nom=e.target.options[e.target.selectedIndex].text, img=document.getElementById("sectorImgPreview");
        if(e.target.value){ img.src=`/img/${nom}.png`; img.style.display='block'; img.style.width='300px'; img.style.margin='0 auto'; }
        else img.style.display='none';
        fetchEspacios();
    };

    function fetchEspacios(){
        const tId=window.tipoSeleccionadoId, sId=document.getElementById("sectorSelect").value;
        const f=formRes.querySelector('input[name="fecha"]').value, ent=formRes.querySelector('input[name="entrada"]').value, sal=formRes.querySelector('input[name="salida"]').value;
        document.getElementById("espaciosContainer").innerHTML="";
        if(!tId||!sId||!f||!ent||!sal || sal<=ent) return;

        fetch(`/reservas/espacios?sectorId=${sId}&tipoVehiculoId=${tId}&fecha=${f}&entrada=${ent}&salida=${sal}`).then(r=>r.json()).then(d=>{
            let html=""; d.forEach(e=>{
                const hasSub=e.subEspacios&&e.subEspacios.length>0, subData=hasSub?JSON.stringify(e.subEspacios).replace(/"/g,'&quot;'):"";
                html+=`<div class="espacio ${e.estado}" data-id="${e.id}" data-has-sub="${hasSub}" data-sub='${subData}' data-nombre="${e.nombre}" onclick="manejarClickEspacio(this)">${e.nombre}</div>`;
            });
            renderEspacios(html);
        });
    }

    function manejarClickEspacio(el){
        const hasSub=el.getAttribute("data-has-sub")==="true", estado=el.classList.contains("OCUPADO");
        if(hasSub){ abrirModalSub(el.getAttribute("data-id"), el.getAttribute("data-nombre"), JSON.parse(el.getAttribute("data-sub"))); }
        else { if(estado)return alert("Este espacio ya está ocupado."); selectEspacio(el.getAttribute("data-id")); document.querySelectorAll(".espacio").forEach(e=>e.classList.remove("sel")); el.classList.add("sel"); }
    }

    function selectEspacio(id, subId=null){
        let hE=document.getElementById("espacioId"); if(!hE){hE=document.createElement("input");hE.type="hidden";hE.name="espacioId";hE.id="espacioId";formRes.appendChild(hE)} hE.value=id;
        let hS=document.getElementById("subEspacioId"); if(!hS){hS=document.createElement("input");hS.type="hidden";hS.name="subEspacioId";hS.id="subEspacioId";formRes.appendChild(hS)} hS.value=subId||"";
    }

    function renderEspacios(html){
        const c=document.getElementById("espaciosContainer");
        c.innerHTML=`<div class="espacios-wrapper" style="display:flex;align-items:center;gap:5px;"><div class="espacio-arrow left" id="al" style="cursor:pointer;padding:8px;border-radius:6px;background:#eee;"><span class="material-symbols-outlined">chevron_left</span></div><div class="espacios-scroller" id="sc" style="display:flex;gap:10px;overflow-x:auto;padding:10px;scroll-behavior:smooth;">${html||'<p style="color:#777;width:100%;text-align:center;">No hay espacios disponibles.</p>'}</div><div class="espacio-arrow right" id="ar" style="cursor:pointer;padding:8px;border-radius:6px;background:#eee;"><span class="material-symbols-outlined">chevron_right</span></div></div>`;
        const sc=document.getElementById("sc"), al=document.getElementById("al"), ar=document.getElementById("ar");
        const checkScroll = () => { if(sc.scrollWidth <= sc.clientWidth) { al.style.display='none'; ar.style.display='none'; } else { al.style.display='flex'; ar.style.display='flex'; } };
        setTimeout(checkScroll, 100);
        al.onclick = () => sc.scrollBy({ left: -220, behavior: "smooth" });
        ar.onclick = () => sc.scrollBy({ left: 220, behavior: "smooth" });
    }

    /* ===========================
       MODAL SUB-ESPACIOS (BICICLETAS)
    =========================== */
    const mSub=document.getElementById("modalSubEspacios");
    let tSub=null, tPadre=null;

    function abrirModalSub(idP, nomP, lista){
        document.getElementById("tituloSubEspacio").textContent="Espacio "+nomP;
        const c=document.getElementById("containerSubEspacios"); c.innerHTML="";
        tSub=null; tPadre=idP;
        lista.forEach(s=>{
            const d=document.createElement("div"); d.className=`espacio ${s.estado} sub-espacio-item`; d.textContent=s.nombre;
            d.onclick=()=>{
                if(s.estado==='OCUPADO')return;
                document.querySelectorAll(".sub-espacio-item").forEach(e=>e.classList.remove("sel"));
                d.classList.add("sel");
                tSub=s.id;
            };
            c.appendChild(d);
        });
        mSub.style.display="flex";
    }

    document.getElementById("btnAceptarSub").onclick=()=>{
        if(!tSub) return alert("Selecciona un sitio primero");
        selectEspacio(tPadre,tSub);
        mSub.style.display="none";
        const p=document.querySelector(`.espacio[data-id='${tPadre}']`);
        if(p){document.querySelectorAll(".espacio").forEach(e=>e.classList.remove("sel")); p.classList.add("sel")}
    };
    document.getElementById("cerrarModalSub").onclick=()=>mSub.style.display="none";

    /* ===========================
       GUARDAR RESERVA
    =========================== */
    formRes.addEventListener("submit",e=>{
        e.preventDefault();
        if(!document.getElementById("espacioId")||!document.getElementById("espacioId").value) return alert("Seleccione espacio");
        fetch('/reservas/guardar',{method:'POST',body:new FormData(formRes)}).then(r=>r.json()).then(d=>{
            if(d.success){
                document.getElementById("modalConfirmacion").classList.add("show");
                document.getElementById("modalFormularioReserva").style.display="none";
                updateCounters(d.totales);
                showActiveReservation(d.nuevaReserva);
            } else {
                if(d.error==="ocupado"){ alert("Espacio ocupado en ese horario"); fetchEspacios(); }
                else alert("Error: "+d.error);
            }
        }).catch(e=>alert("Error red"));
    });

    /* ===========================
       CANCELAR RESERVA (CON NUEVOS MODALES)
    =========================== */
    const csrfToken = document.querySelector('input[name="_csrf"]').value;
    let idReservaPendiente = null;

    function solicitarCancelacion(id) {
        idReservaPendiente = id;
        document.getElementById("modalPreguntaCancelacion").classList.add("show");
    }

    window.solicitarCancelacion = solicitarCancelacion;

    document.getElementById("btnConfirmarCancelacion").onclick = () => {
        if(!idReservaPendiente) return;

        document.getElementById("modalPreguntaCancelacion").classList.remove("show");

        fetch('/reservas/cancelar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRF-TOKEN': csrfToken },
            body: `id=${idReservaPendiente}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const blueSection = document.getElementById("blue-section-container");
                if(blueSection) blueSection.remove();

                const emptyState = document.getElementById("empty-state-container");
                if(emptyState) emptyState.style.display = "block";

                const btnEmpty = document.getElementById("btnAbrirReserva");
                const btnActive = document.getElementById("btnAbrirReservaNueva");
                if(btnEmpty) btnEmpty.style.display = "inline-block";
                if(btnActive) btnActive.style.display = "none";

                if(data.totales) updateCounters(data.totales);

                document.getElementById("modalCancelacionExito").classList.add("show");
            } else {
                if (data.error === 'tiempo_limite') {
                    document.getElementById("modalErrorCancelacion").classList.add("show");
                } else {
                    alert("Error al cancelar: " + data.error);
                }
            }
        })
        .catch(err => alert("Error de red al cancelar"));
    };

    document.getElementById("btnVolverCancelacion").onclick = () => {
        document.getElementById("modalPreguntaCancelacion").classList.remove("show");
        idReservaPendiente = null;
    };


    /* ===========================
       HELPERS UI
    =========================== */
    function updateCounters(totales){
        if(!totales) return;
        document.querySelector('.status-area .status-box.disponible .count').textContent = totales.disponibles;
        document.querySelector('.status-area .status-box.ocupado .count').textContent = totales.ocupados;
        const resBoxes = document.querySelectorAll('#vistaReservaciones .status-box');
        if(resBoxes.length>=2){
            resBoxes[0].querySelector('.count').textContent = totales.disponibles;
            resBoxes[1].querySelector('.count').textContent = totales.ocupados;
        }
    }

    function showActiveReservation(newReserva){
        const emptyState = document.getElementById("empty-state-container");
        if (emptyState) emptyState.style.display = "none";

        const newCardHTML = `
            <div class="reserva-activa-card">
                <div class="reserva-info">
                    <div class="reserva-fechas">
                        <div class="info-item"><span class="material-symbols-outlined">calendar_today</span><span>Fecha: <strong>${newReserva.fecha}</strong></span></div>
                        <div class="info-item"><span class="material-symbols-outlined">schedule</span><span>Entrada: <strong>${newReserva.entrada}</strong></span></div>
                        <div class="info-item"><span class="material-symbols-outlined">schedule</span><span>Salida: <strong>${newReserva.salida}</strong></span></div>
                    </div>
                    <div class="reserva-lugar">
                        <h6>Datos de Lugar:</h6>
                        <p>Sector: <strong>${newReserva.sector}</strong></p>
                        <p>Lugar: <strong>${newReserva.espacio}</strong></p>
                        <div class="btn-container">
                            <button class="btn-detalles">Detalles</button>

                            <button class="btn-cancelar" onclick="solicitarCancelacion(${newReserva.id})">Cancelar</button>

                        </div>
                    </div>
                    <div class="reserva-acciones">
                        <span class="status-chip">${newReserva.estado}</span>
                    </div>
                </div>
            </div>
        `;

        let blueSection = document.getElementById("blue-section-container");
        if (!blueSection) {
            blueSection = document.createElement("div");
            blueSection.className = "blue-section";
            blueSection.id = "blue-section-container";
            blueSection.innerHTML = `<div class="content-container"><div id="active-reservation-container"></div></div>`;
            if(emptyState) emptyState.insertAdjacentElement("afterend", blueSection);
        }
        blueSection.querySelector("#active-reservation-container").innerHTML = newCardHTML;

        const btnEmpty = document.getElementById("btnAbrirReserva");
        const btnActive = document.getElementById("btnAbrirReservaNueva");
        if(btnEmpty) btnEmpty.style.display = "none";

        if(!btnActive) {
            const newBtn = document.createElement("button");
            newBtn.id = "btnAbrirReservaNueva";
            newBtn.className = "btn-reservar-secondary";
            newBtn.textContent = "Reservar";
            newBtn.onclick = () => modalTipo.style.display = "flex";
            document.querySelector(".reservar-button-container").appendChild(newBtn);
        } else {
            btnActive.style.display = "inline-block";
        }
    }

    /* ===========================
       VEHICULOS Y OTROS
    =========================== */
    document.getElementById("btnVehiculos").onclick=()=>{
        fetch('/vehiculos/mios').then(r=>r.json()).then(d=>{
            const tb=document.getElementById("vehiculosTableBody"); tb.innerHTML="";
            d.forEach(v=>{
                const tr=document.createElement("tr");
                tr.innerHTML=`<td>${v.tipoVehiculoNombre}</td><td>${v.placa}</td><td style="text-align:center;"><button onclick="eliminarVehiculo(${v.id})" class="btn-eliminar">Eliminar</button></td>`;
                tb.appendChild(tr);
            });
            document.getElementById("modalVehiculos").style.display="flex";
        });
    };
    document.getElementById("cerrarModalVehiculos").onclick=()=>document.getElementById("modalVehiculos").style.display="none";
    document.getElementById("btnAgregarVehiculo").onclick=()=>{
        const t=document.getElementById("nuevoTipoVehiculo").value, p=document.getElementById("nuevaPlaca").value.trim();
        if(!t||!p) return alert("Complete");
        fetch('/vehiculos/agregar',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken},body:JSON.stringify({tipoId:t,placa:p})})
        .then(r=>r.json()).then(d=>{if(d.success){document.getElementById("btnVehiculos").click();document.getElementById("nuevaPlaca").value=""}else alert(d.error)});
    };
    function eliminarVehiculo(id){ if(confirm("Eliminar?")) fetch(`/vehiculos/eliminar/${id}`,{method:'DELETE',headers:{'X-CSRF-TOKEN':csrfToken}}).then(r=>r.json()).then(d=>{if(d.success)document.getElementById("btnVehiculos").click()}); }

    /* ===========================
       LOADER Y CIERRE DE MODALES
    =========================== */
    window.onload=()=>{
        const l=document.getElementById('loader-container'), c=document.getElementById('main-content');
        setTimeout(()=>{if(l){l.style.opacity='0';l.style.visibility='hidden'}if(c){c.style.visibility='visible';c.style.opacity='1'}setTimeout(()=>{if(l)l.style.display='none'},500)},200);
    };

    const clsM=(m)=>m.classList.remove("show");

    const mConf = document.getElementById("modalConfirmacion");
    if(document.getElementById("cerrarModalConfirmacion")) document.getElementById("cerrarModalConfirmacion").onclick=()=>clsM(mConf);
    if(document.getElementById("btnAceptarConfirmacion")) document.getElementById("btnAceptarConfirmacion").onclick=()=>clsM(mConf);

    const mCancEx = document.getElementById("modalCancelacionExito");
    if(document.getElementById("cerrarModalCancelacion")) document.getElementById("cerrarModalCancelacion").onclick=()=>clsM(mCancEx);
    if(document.getElementById("btnAceptarCancelacion")) document.getElementById("btnAceptarCancelacion").onclick=()=>clsM(mCancEx);

    const mErr = document.getElementById("modalErrorCancelacion");
    if(document.getElementById("cerrarModalError")) document.getElementById("cerrarModalError").onclick=()=>clsM(mErr);
    if(document.getElementById("btnAceptarError")) document.getElementById("btnAceptarError").onclick=()=>clsM(mErr);

    window.onclick = e => {
        if(e.target === mConf) clsM(mConf);
        if(e.target === mCanc) clsM(mCanc);
        if(e.target === document.getElementById("modalPreguntaCancelacion"))
            document.getElementById("modalPreguntaCancelacion").classList.remove("show");
        if(e.target === document.getElementById("modalErrorCancelacion"))
            document.getElementById("modalErrorCancelacion").classList.remove("show");
        if(e.target === modalTipo) modalTipo.style.display="none";
    };

</script>

</body>
</html>